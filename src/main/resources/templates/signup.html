<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>회원가입</title>

    <script>
        async function checkLoginId() {
            const loginId = document.getElementById("loginId").value;
            if (!loginId) {
                setLoginIdMsg("");
                return;
            }
            const res = await fetch(`/check/loginId?loginId=${loginId}`);
            const isDuplicate = await res.json();
            setLoginIdMsg(isDuplicate ? "이미 존재하는 아이디입니다." : "사용 가능한 아이디입니다.", isDuplicate);
        }

        async function checkNickname() {
            const nickname = document.getElementById("nickname").value;
            if (!nickname) {
                setNicknameMsg("");
                return;
            }
            const res = await fetch(`/check/nickname?nickname=${nickname}`);
            const isDuplicate = await res.json();
            setNicknameMsg(isDuplicate ? "이미 존재하는 닉네임입니다." : "사용 가능한 닉네임입니다.", isDuplicate);
        }

        function setLoginIdMsg(msg, isError) {
            const el = document.getElementById("loginId-msg");
            el.innerText = msg;
            el.style.color = isError ? "red" : "green";
        }

        function setNicknameMsg(msg, isError) {
            const el = document.getElementById("nickname-msg");
            el.innerText = msg;
            el.style.color = isError ? "red" : "green";
        }

        function checkPasswordMatch() {
            const pw = document.getElementById("password").value;
            const pwConfirm = document.getElementById("passwordConfirm").value;
            const msgEl = document.getElementById("password-match-msg");

            if (!pwConfirm) {
                msgEl.innerText = "";
                return;
            }

            if (pw !== pwConfirm) {
                msgEl.innerText = "비밀번호가 일치하지 않습니다.";
                msgEl.style.color = "red";
            } else {
                msgEl.innerText = "";
            }
        }

        async function sendCode() {
            const email = document.getElementById("email").value;
            const msgEl = document.getElementById("email-send-msg");
            const btn = event.target;

            if (!email) {
                msgEl.innerText = "이메일을 입력해주세요.";
                msgEl.style.color = "red";
                return;
            }

            // 클릭 시 안내 메시지 표시 + 버튼 비활성화
            btn.disabled = true;
            btn.textContent = "발송 중...";
            msgEl.innerText = "인증코드 발송 중입니다. 잠시만 기다려 주세요.";
            msgEl.style.color = "blue";

            try {
                // 서버 요청
                const res = await fetch("/email/send", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: "email=" + encodeURIComponent(email)
                });

                // 응답 메시지 표시
                const msg = await res.text();
                msgEl.innerText = msg;
                msgEl.style.color = res.ok ? "green" : "red";

            } catch (error) {
                msgEl.innerText = "서버와 연결할 수 없습니다. 잠시 후 다시 시도해 주세요.";
                msgEl.style.color = "red";
            } finally {
                // 버튼 복구
                btn.disabled = false;
                btn.textContent = "인증코드 발송";
            }
        }

        async function verifyCode() {
            const email = document.getElementById("email").value;
            const verificationCode = document.getElementById("emailCode").value;
            const msgEl = document.getElementById("email-verify-msg");

            if (!verificationCode) {
                msgEl.innerText = "인증 코드를 입력해주세요.";
                msgEl.style.color = "red";
                return;
            }

            const res = await fetch("/email/verify", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `email=${encodeURIComponent(email)}&verificationCode=${encodeURIComponent(verificationCode)}`
            });

            const msg = await res.text();

            if (res.ok) {
                msgEl.innerText = "이메일 인증에 성공하셨습니다.";
                msgEl.style.color = "green";
            } else {
                msgEl.innerText = msg;
                msgEl.style.color = "red";
            }
        }
    </script>

    <style>
        .container {
          flex: 1;
          display: flex;
          justify-content: center;
          align-items: center;
        }
        .signupContainer {
          display: flex;
          flex-direction: column;
          align-items: center;
          width: 688px;
          margin-top: 100px;
        }
        label {
          display: block;
          margin-bottom: 10px;
          font-size: 18px;
          font-weight: bold;
        }
        .input-row {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 4px;
        }
        .msg {
          margin-top: 4px;
          margin-left: 2px;
          font-size: 16px;
        }
        .signupBtn {
          width: 528px;
          height: 49px;
          background: #FF6F0E;
          border-radius: 10px;
          font-size: 16px;
          color: #FFFFFF;
          border: none;
          cursor: pointer;
        }
        .input-field {
          width: 400px;
          height: 49px;
          padding: 8px;
          font-size: 16px;
          box-sizing: border-box;
          border: 1px solid #ccc;
          border-radius: 10px;
          outline: none;
        }
        .check-btn {
          width: 120px;
          height: 49px;
          background: #FF6F0E;
          font-size: 16px;
          color: #FFFFFF;
          border: none;
          border-radius: 10px;
          cursor: pointer;
        }
        .check-btn:disabled {
            cursor: default;
            opacity: 0.6;
        }
        .guideText {
          color: gray;
          margin-bottom: 30px;
          font-size: 16px;
          margin-top: 4px;
        }
        .login {
          font-size: 16px;
          font-weight: bold;
          border: none;
          color: #FF6F0E;
          cursor: pointer;
        }

      @media screen and (max-width: 768px) {
      .container {
        margin-top: 100px;
        padding-top: 80px;
      }

      .input-row {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .input-field {
        width: 100%;
      }

      .check-btn {
        width: 100%;
      }

      .signupBtn {
        width: 100%;
      }

      form {
        width: 100%;
      }

      .guideText {
        font-size: 14px;
      }

      label {
        font-size: 16px;
      }

      .login {
        width: 100%;
        font-size: 16px;
      }

      body > div[style*="flex: 1"] > div {
        width: 90%;
      }
    }
    </style>
</head>
<body style="margin: 0; height: 100vh; display: flex; flex-direction: column;">

<div class="container">
    <div class="signupContainer">

        <div th:if="${error}" style="color:red;" th:text="${error}"></div>

        <form method="post" th:object="${user}" th:action="@{/signup}">

            <label>아이디</label>
            <div class="input-row">
                <input type="text" th:field="*{loginId}" id="loginId" placeholder="아이디 (필수 입력)" class="input-field" required />
                <button type="button" onclick="checkLoginId()" class="check-btn">중복확인</button>
            </div>
            <div id="loginId-msg" class="msg"></div>
            <div class="guideText">영문/숫자 6~20자, 특수문자 X</div>

            <label>비밀번호</label>
            <div class="input-row">
                <input type="password" th:field="*{password}" id="password" placeholder="비밀번호 (필수 입력)" oninput="checkPasswordMatch()" class="input-field" required />
            </div>
            <div class="msg"></div>
            <div class="guideText">영문+숫자 필수 8~20자, 특수문자 허용 (!@#$%^&*())</div>

            <label>비밀번호 확인</label>
            <div class="input-row">
                <input type="password" th:field="*{passwordConfirm}" id="passwordConfirm" placeholder="비밀번호 확인 (필수 입력)" oninput="checkPasswordMatch()" class="input-field" required />
            </div>
            <div id="password-match-msg" class="msg"></div>
            <div class="guideText"></div>

            <label style="margin-top: 15px;">닉네임</label>
            <div class="input-row">
                <input type="text" th:field="*{nickname}" id="nickname" placeholder="닉네임 (필수)" class="input-field" required />
                <button type="button" onclick="checkNickname()" class="check-btn">중복확인</button>
            </div>
            <div id="nickname-msg" class="msg"></div>
            <div class="guideText">한글/영문/숫자 4~12자, 특수문자 X</div>

            <label style="margin-top: 15px;">이메일</label>
            <div class="input-row">
                <input type="email" th:field="*{email}" id="email" placeholder="이메일 (필수 입력)" class="input-field" required />
                <button type="button" onclick="sendCode()" class="check-btn">인증코드 발송</button>
            </div>
            <div class="msg" id="email-send-msg"></div>

            <div class="input-row" style="margin-top: 10px;">
                <input type="text" id="emailCode" placeholder="6자리 인증 코드 입력" class="input-field" />
                <button type="button" onclick="verifyCode()" class="check-btn">인증 확인</button>
            </div>
            <div class="msg" id="email-verify-msg"></div>
            <div class="guideText">이메일로 전송된 인증 코드를 입력해 주세요.</div>

            <button type="submit" class="signupBtn">회원가입</button>
        </form>

        <div style="margin-top: 30px; display: flex; flex-direction: column; align-items: center;">
            <p>이미 계정이 있으신가요?</p>
            <form method="get" action="/login">
                <button type="submit" class="login">로그인</button>
            </form>
        </div>
    </div>
</div>
</body>
</html>