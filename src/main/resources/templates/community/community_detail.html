<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${post.title}">게시글 상세</title>
    <link rel="stylesheet" th:href="@{/css/common/header.css}">
    <link rel="stylesheet" th:href="@{/css/common/footer.css}">
    <link rel="stylesheet" th:href="@{/css/common/styles.css}">
    <link rel="stylesheet" th:href="@{/css/community/community_layout.css}">
    <link rel="stylesheet" th:href="@{/css/community/community_detail.css}">
</head>
<body>
<header th:replace="~{fragments/header :: header}"></header>
<div class="page-wrapper">
    <main class="detail-main-container">
        <!-- 게시글 컨텐츠 영역 -->
        <div class="post-container">
            <header class="post-header">
                <div class="title-and-tags">
                    <span class="tag"
                          th:text="${post.category.name() == 'study' ? '스터디 그룹 모집' :
                            (post.category.name() == 'question' ? '질문 & 답변' : '자유 게시판')}"></span>
                    <div class="title-wrapper">
                        <h1 th:text="${post.title}"></h1>
                        <th:block th:if="${post.category.name() == 'study'}">
                            <span class="detail-post-status"
                                  th:text="${post.status == 'ACTIVE' ? '모집중' : '모집완료'}"
                                  th:classappend="${post.status == 'ACTIVE' ? 'status-active' : 'status-inactive'}">
                            </span>
                        </th:block>
                    </div>
                </div>
                <div class="action-buttons"
                     th:if="${#authorization.expression('isAuthenticated()') and #authentication.principal.getUser().getUserIdx() == post.authorUserIdx}">
                    <a th:href="@{/community/{id}/edit(id=${post.postIdx})}" class="btn-secondary">수정</a>
                    <form th:action="@{/community/{id}/delete(id=${post.postIdx})}" method="post" onsubmit="return confirm('정말로 삭제하시겠습니까?');">
                        <button type="submit" class="btn-secondary">삭제</button>
                    </form>
                </div>
            </header>

            <div class="author-meta">
                <div class="author-profile">
                    <img th:src="${post.authorProfileImg != null ? post.authorProfileImg : '/assets/images/default-profile.png'}" alt="프로필">
                    <span class="author-name" th:text="${post.authorNickname}"></span>
                </div>
                <div class="post-info">
                    <span class="timestamp" th:text="${#temporals.format(post.createdAt, 'yyyy.MM.dd HH:mm')}"></span>
                    <div class="post-stats">
                        <span class="views">
                            <img th:src="@{/assets/icon/eye.svg}" alt="조회수"/>
                            <span th:text="${post.views}">0</span>
                        </span>
                        <span class="likes">
                            <img th:src="@{/assets/icon/hand-thumbs-up.svg}" alt="좋아요"/>
                            <span th:text="${post.likeCount}">0</span>
                        </span>
                        <span class="comments">
                            <img th:src="@{/assets/icon/chat.svg}" alt="댓글 수"/>
                            <span th:text="${post.totalCommentCount}">0</span>
                        </span>
                    </div>
                </div>
            </div>

            <section class="post-content" th:utext="${post.content}"></section>

            <div class="like-button-wrapper">
                <form th:action="@{/community/{id}/like(id=${post.postIdx})}" method="post">
                    <div class="like-button-wrapper">
                        <form th:action="@{/community/{id}/like(id=${post.postIdx})}" method="post">
                            <button type="submit" class="btn-like" th:classappend="${post.likedByCurrentUser} ? 'liked' : ''">
                                <span class="like-icon" th:text="${post.likedByCurrentUser ? '♡' : '♥'}"></span>
                                <span class="like-text" th:text="${post.likedByCurrentUser ? '좋아요 취소' : '좋아요'}"></span>
                            </button>
                        </form>
                    </div>
                </form>
            </div>
        </div>

        <!-- 댓글 섹션 -->
        <section class="comment-container">
            <h2>댓글 <span id="comment-count" th:text="${post.totalCommentCount}"></span> 개</h2>

            <div class="comment-write-box" id="main-comment-form-container" th:if="${#authentication.isAuthenticated()}">
                <div class="comment-form-area">
                    <form th:action="@{/community/{id}/comments(id=${post.postIdx})}" th:object="${commentRequest}" method="post" class="comment-form" id="main-comment-form">
                        <input type="hidden" th:field="*{parentId}"/>
                        <textarea th:field="*{content}" placeholder="댓글 내용을 작성해주세요" required></textarea>
                        <div class="comment-form-actions">
                            <button type="submit" class="btn-submit">작성</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="comment-login-prompt" th:unless="${#authentication.isAuthenticated()}">
                <p>댓글을 작성하려면 <a th:href="@{/login}">로그인</a>이 필요합니다.</p>
            </div>

            <div th:replace="~{fragments/comment_tree :: commentTree(comments=${post.comments})}"></div>
        </section>
    </main>
</div>
<footer th:replace="~{fragments/footer :: footer}"></footer>
<script th:src="@{/js/community/community-comment.js}"></script>
</body>
</html>