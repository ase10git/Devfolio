<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>커뮤니티</title>
    <link rel="stylesheet" th:href="@{/css/common/header.css}">
    <link rel="stylesheet" th:href="@{/css/common/footer.css}">
    <link rel="stylesheet" th:href="@{/css/common/styles.css}">
    <link rel="stylesheet" th:href="@{/css/community/community_layout.css}">
    <link rel="stylesheet" th:href="@{/css/community/community_list.css}">
</head>
<body>
<header th:replace="~{fragments/header :: header}"></header>
<div class="page-wrapper">
    <div class="page-title-area">
        <h1>커뮤니티</h1>
        <p>커뮤니티에서 스터디 그룹을 모집하거나 질의응답을 통해 다른 개발자와 소통하세요</p>
    </div>

    <main class="community-main">
        <aside class="category-sidebar">
            <h2>커뮤니티 카테고리</h2>
            <ul>
                <li><a href="/community">전체</a></li>
                <li th:each="category : ${categories}">
                    <a th:href="${'/community/search?categoryName=' + category}"
                       th:data-category="${category}"
                       th:text="${category.nameKo}"></a>
                </li>
            </ul>
        </aside>

        <section class="content-area">
            <!-- 1. 검색창 -->
            <form class="search-bar" th:action="@{/community/search}" method="get" id="search-form">
                <select class="categories"
                        th:field="${requestDto.categoryName}"
                >
                    <option value="">전체</option>
                    <option
                            th:each="category: ${categories}"
                            th:value="${category}"
                            th:text="${category.nameKo}"
                    ></option>
                </select>
                <input type="text" name="keyword" placeholder="검색 키워드를 입력해주세요"
                       th:value="${requestDto.keyword}">
                <button type="submit" class="search-btn"><img th:src="@{/assets/icon/search_white.svg}" alt="검색 아이콘"/></button>
            </form>

            <!-- 2. 정렬 탭과 글쓰기 버튼 -->
            <div class="actions-and-sort">
                <div class="sort-tabs">
                    <button type="button"
                            th:each="sort : ${sortOptions}"
                            th:data-sort="${sort}"
                            th:classappend="${#strings.equals(requestDto.sort, sort) ? 'active' : ''}"
                            th:text="${sort.fieldNameKo}"
                    ></button>
                </div>
                <a th:href="@{/community/new}" class="btn-primary">새 게시글 작성</a>
            </div>

            <!-- 3. 게시글 목록 -->
            <div class="post-list-container">
                <div th:if="${postPage.isEmpty()}" class="no-posts">
                    <p>등록된 게시글이 없습니다.</p>
                </div>
                <div th:unless="${postPage.isEmpty()}" class="post-list">
                    <article class="post-item" th:each="post : ${postPage.content}">
                        <div class="post-item-main">
                            <span class="tag"
                                  th:if="${post.category.name() == 'study'}"
                                  th:classappend="${post.status == 'ACTIVE'} ? 'recruiting' : 'completed'"
                                  th:text="${post.status == 'ACTIVE'} ? '모집중' : '모집완료'"></span>
                            <h3 class="post-title"><a th:href="@{/community/{id}(id=${post.postIdx})}" th:text="${post.title}"></a></h3>
                            <p class="post-category"
                               th:text="${post.category.name() == 'study' ? '스터디 그룹 모집' :
                                    (post.category.name() == 'question' ? '질문&답변' : '자유 게시판')}">
                            </p><p class="post-snippet" th:utext="${#strings.abbreviate(post.content, 150)}"></p>
                        </div>
                        <div class="post-item-meta">
                            <div class="author-info">
                                <img th:src="${post.authorProfileImg != null ? post.authorProfileImg : '/assets/images/default-profile.png'}" alt="프로필">
                                <span th:text="${post.authorNickname}"></span>
                                <span class="timestamp" th:text="' • ' + ${#temporals.format(post.createdAt, 'yyyy-MM-dd')}"></span>
                            </div>
                            <div class="post-stats">
                                <span><img th:src="@{/assets/icon/eye.svg}" alt="조회수 아이콘"/> <span th:text="${post.views}"></span></span>
                                <span>♥ <span th:text="${post.likeCount}"></span></span>
                                <span><img th:src="@{/assets/icon/chat.svg}" alt="댓글 아이콘"/> <span th:text="${post.commentCount}"></span></span>
                            </div>
                        </div>
                    </article>
                </div>
            </div>

            <!-- 페이징 -->
            <nav th:if="${postPage.totalPages > 1}" class="pagination">
                <ul>
                    <li th:classappend="${postPage.first} ? 'disabled' : ''">
                        <a th:href="@{/community(page=0)}">«</a>
                    </li>
                    <li th:classappend="${!postPage.hasPrevious()} ? 'disabled' : ''">
                        <a th:href="@{/community(page=postPage.number-1)}">‹</a>
                    </li>
                    <li th:each="pageNum : ${#numbers.sequence(0, postPage.totalPages - 1)}"
                        th:if="${pageNum >= postPage.number - 2 and pageNum <= postPage.number + 2}">
                        <a th:href="@{/community(page=${pageNum})}" th:text="${pageNum + 1}"
                           th:classappend="${pageNum == postPage.number} ? 'active' : ''"></a>
                    </li>
                    <li th:classappend="${!postPage.hasNext()} ? 'disabled' : ''">
                        <a th:href="@{/community(page=${postPage.number+1})}">›</a>
                    </li>
                    <li th:classappend="${postPage.last} ? 'disabled' : ''">
                        <a th:href="@{/community(page=postPage.totalPages-1)}">»</a>
                    </li>
                </ul>
            </nav>
        </section>
    </main>
</div>
<footer th:replace="~{fragments/footer :: footer}"></footer>
<script type="module" th:src="@{/js/community/community-list.js}"></script>
</body>
</html>